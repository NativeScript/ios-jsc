#!/usr/bin/env bash

set -e

source "$(dirname "$0")/common.sh"

CONFIGURATION="Release"
MACOSX_DEPLOYMENT_TARGET="10.13"

WEBKIT_SOURCE_PATH="$WORKSPACE/src/webkit"
WEBKIT_BUILD_OUTPUT_PATH="$WORKSPACE/cmake-build/WebKit-Xcode"
BUILD_DIR="$WORKSPACE/build"

INSPECTOR_SOURCE_PATH="$WORKSPACE/src/debugging/Inspector/Inspector"
INSPECTOR_BUILD_OUTPUT_PATH="$WORKSPACE/cmake-build/Inspector"

checkpoint "Inspector build started"
mkdir -p "$WORKSPACE/cmake-build"

checkpoint "Building WebKit"
xcodebuild \
    -workspace "$WEBKIT_SOURCE_PATH/WebKit.xcworkspace" \
    -configuration "$CONFIGURATION" \
    -scheme "All Source" \
    -derivedDataPath "$WEBKIT_BUILD_OUTPUT_PATH" \
    VALID_ARCHS="x86_64" ARCHS="x86_64" ONLY_ACTIVE_ARCH="NO" \
    MACOSX_DEPLOYMENT_TARGET="$MACOSX_DEPLOYMENT_TARGET" \
    build \
    -quiet

# These are some invalid symlinks that are generated by Xcode sometimes in the CI
rm -f "$WEBKIT_BUILD_OUTPUT_PATH/Build/Products/$CONFIGURATION/WebKit.framework/DatabaseProcess.app/DatabaseProcess.app"
rm -f "$WEBKIT_BUILD_OUTPUT_PATH/Build/Products/$CONFIGURATION/WebKit.framework/NetworkProcess.app/NetworkProcess.app"
rm -f "$WEBKIT_BUILD_OUTPUT_PATH/Build/Products/$CONFIGURATION/WebKit.framework/PluginProcess.app/PluginProcess.app"
rm -f "$WEBKIT_BUILD_OUTPUT_PATH/Build/Products/$CONFIGURATION/WebKit.framework/WebProcess.app/WebProcess.app"
rm -f "$WEBKIT_BUILD_OUTPUT_PATH/Build/Products/$CONFIGURATION/WebKit.framework/XPCServices/XPCServices"

checkpoint "Copying frameworks"
rm -rf "$INSPECTOR_SOURCE_PATH/Frameworks"
find "$WEBKIT_BUILD_OUTPUT_PATH/Build/Products/$CONFIGURATION" -name "*.framework" -type d -maxdepth 1 -print \
    -exec rsync -a {} "$INSPECTOR_SOURCE_PATH/Frameworks/" \;

checkpoint "Building Inspector app"
rm -rf "$INSPECTOR_BUILD_OUTPUT_PATH"

VERSION=$(python "$BUILD_DIR/scripts/get_version.py" "$BUILD_DIR/npm/inspector_package.json" 2>&1)
IFS=';' read -ra VERSION_ARRAY <<< "$VERSION"

xcodebuild \
    -project "$INSPECTOR_SOURCE_PATH/Inspector.xcodeproj" \
    -scheme "Inspector" \
    -archivePath "$INSPECTOR_BUILD_OUTPUT_PATH/Inspector.xcarchive" \
    MACOSX_DEPLOYMENT_TARGET="$MACOSX_DEPLOYMENT_TARGET" \
    PACKAGE_VERSION="${VERSION_ARRAY[0]}" \
    archive \
    -quiet
xcodebuild \
    -exportArchive \
    -archivePath "$INSPECTOR_BUILD_OUTPUT_PATH/Inspector.xcarchive" \
    -exportOptionsPlist "$INSPECTOR_SOURCE_PATH/export-options.plist" \
    -exportPath "$INSPECTOR_BUILD_OUTPUT_PATH" \
    -quiet

checkpoint "Packaging Inspector app"
pushd "$INSPECTOR_BUILD_OUTPUT_PATH"
mv "Inspector.app" "NativeScript Inspector.app"
zip -r \
    --symlinks \
    "NativeScript Inspector.zip" \
    "NativeScript Inspector.app"
popd

mkdir -p "$DIST_DIR"
cp "$INSPECTOR_BUILD_OUTPUT_PATH/NativeScript Inspector.zip" "$DIST_DIR"

checkpoint "Inspector build finished - $DIST_DIR/NativeScript Inspector.zip"
